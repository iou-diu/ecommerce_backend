{% extends 'includes/main.html' %}
{% load static %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center p-3">
                        <h4 class="card-title fw-bold m-0 px-4">Update Stock with Variant</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group col-md-9">
                                <label>Product Name: </label>
                                <input class="form-control" type="text" value="{{ object.name }}" readonly>
                            </div>
                            <div class="form-group col-md-3">
                                <label>Brand: </label>
                                <input class="form-control" type="text" value="{{ object.brand }}" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br>

        <form id="variantForm">
            {% csrf_token %}
            <div id="variantContainer">
                <div class="row mb-4 variant-form">
                    <div class="col-md-10 mx-auto">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>SKU</label>
                                            <input type="text" class="form-control sku" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>UPC</label>
                                            <input type="text" class="form-control upc" required>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Price</label>
                                            <input type="number" step="0.01" class="form-control price" required>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Retail Price</label>
                                            <input type="number" step="0.01" class="form-control retail-price">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Offer Price</label>
                                            <input type="number" step="0.01" class="form-control offer-price" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Offer start time</label>
                                            <input type="datetime-local" class="form-control offer-start-time">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Offer end time</label>
                                            <input type="datetime-local" class="form-control offer-end-time">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Initial stock quantity</label>
                                            <input type="number" class="form-control stock-quantity">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" class="form-check-input is-active"> Is active
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Attribute</label>
                                            <select class="form-control attribute-select" multiple>
                                                {% for attr in product_attributes %}
                                                    <option value="{{ attr.id }}">{{ attr.attribute.name }}
                                                        ({{ attr.value }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label>Image</label>
                                            <input type="file" class="form-control variant-image" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mt-4">
                                    <button type="button" class="btn btn-danger remove-variant">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row text-center mt-4">
                <div class="col-md-3">
                    <button type="button" class="btn btn-info" id="addVariant">+ Add Variant</button>
                </div>
                <div class="col-md-9">
                    <button type="submit" class="btn btn-primary" id="submitVariants">Submit All Variants</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {
            function getCSRFToken() {
                return $('input[name="csrfmiddlewaretoken"]').val();
            }

            const originalForm = $('#variantContainer .variant-form').first().clone();

            // Initialize Select2 for first form
            initializeSelect2($('.attribute-select').first());

            function initializeSelect2($select) {
                if ($select.hasClass('select2-hidden-accessible')) {
                    $select.select2('destroy');
                }
                $select.closest('.form-group').find('.select2').remove();
                $select.select2({
                    placeholder: "Select Attribute",
                    allowClear: true,
                    width: '100%'
                });
            }

            function generateUniqueId() {
                return 'variant-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            function resetForm($form) {
                const uniqueId = generateUniqueId();
                $form.find('input:not([type="checkbox"])').val('');
                $form.find('input[type="checkbox"]').prop('checked', false);

                const $select = $form.find('.attribute-select');
                $select.attr('id', 'attribute-' + uniqueId);
                $select.val(null);
                initializeSelect2($select);

                return $form;
            }

            function addNewVariantForm() {
                const $newForm = originalForm.clone(true);
                $newForm.find('.select2').remove();
                $newForm.find('.attribute-select')
                    .removeAttr('data-select2-id')
                    .find('option')
                    .removeAttr('data-select2-id');

                resetForm($newForm);

                $newForm.find('.remove-variant').on('click', function () {
                    removeVariantForm($(this));
                });

                $('#variantContainer').append($newForm);

                $('html, body').animate({
                    scrollTop: $newForm.offset().top - 100
                }, 500);
            }

            function removeVariantForm($button) {
                const $form = $button.closest('.variant-form');
                const totalForms = $('.variant-form').length;

                if (totalForms > 1) {
                    const $select = $form.find('.attribute-select');
                    if ($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('destroy');
                    }
                    $form.slideUp(400, function () {
                        $(this).remove();
                    });
                } else {
                    alert('Cannot remove the last variant form. At least one variant is required.');
                }
            }

            $('#addVariant').on('click', function (e) {
                e.preventDefault();
                addNewVariantForm();
            });

            $('.remove-variant').on('click', function (e) {
                e.preventDefault();
                removeVariantForm($(this));
            });

            $('#variantForm').on('submit', function (e) {
                e.preventDefault();

                const formData = new FormData();
                const variants = [];
                let isValid = true;

                $('.variant-form').each(function (index) {
                    const $form = $(this);

                    // Validate required fields
                    $form.find('input[required]').each(function () {
                        if (!$(this).val()) {
                            isValid = false;
                            $(this).addClass('is-invalid');
                        } else {
                            $(this).removeClass('is-invalid');
                        }
                    });

                    if (!isValid) return false;

                    const variant = {
                        sku: $form.find('.sku').val(),
                        upc: $form.find('.upc').val(),
                        price: parseFloat($form.find('.price').val()) || 0,
                        retail_price: parseFloat($form.find('.retail-price').val()) || 0,
                        offer_price: parseFloat($form.find('.offer-price').val()) || 0,
                        offer_start_time: $form.find('.offer-start-time').val(),
                        offer_end_time: $form.find('.offer-end-time').val(),
                        stock_quantity: parseInt($form.find('.stock-quantity').val()) || 0,
                        is_active: $form.find('.is-active').is(':checked'),
                        attributes: $form.find('.attribute-select').val() || []
                    };

                    variants.push(variant);

                    // Handle file upload
                    const fileInput = $form.find('.variant-image')[0];
                    if (fileInput && fileInput.files[0]) {
                        formData.append(`variant_${index}_image`, fileInput.files[0]);
                    }
                });

                if (!isValid) {
                    alert('Please fill in all required fields.');
                    return;
                }

                formData.append('variants', JSON.stringify(variants));

                $.ajax({
                    url: '{% url "productvariant_bulk" pk=object.pk %}',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function (response) {
                        alert('Variants submitted successfully');
                        // window.location.reload();
                        window.location.href = '/ecommerce/productvariant/?product={{ object.pk }}'
                    },
                    error: function (error) {
                        alert('Error submitting variants. Please try again.');
                        console.error('Error:', error);
                    }
                });
            });
        });
    </script>
{% endblock %}