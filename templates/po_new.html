<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="UTF-8">
    <title>Purchase Order Form</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <style>
        .sellinginfo{
            background-color: green!important;
            color: black;
        }
    </style>
</head>
<body>
<div class="container-fluid bg-light p-5 shadow-sm rounded mb-5 mx-5" x-data="purchaseOrderForm()" x-init="init()">
    <h3 class="mb-4 text-primary" x-text="isEditMode ? 'Edit Purchase Order' : 'Add Purchase Order'"></h3>

    <form @submit.prevent="submitForm()">
        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <!-- Button to Open Requisition Modal -->
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#requisitionModal">
                <i class="bi bi-folder"></i> Import from Requisition
            </button>
            <!-- Button to Open Product Modal -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                <i class="bi bi-plus-circle"></i> Add Product
            </button>
        </div>

        <!-- Purchase Order Details -->
        <div class="row g-2 mb-4 py-4 bg-white">
            <!-- Supplier Dropdown -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <label for="supplier" class="form-label">Supplier</label>
                <select class="form-control form-select form-select-sm" id="supplier" x-model="selectedSupplier">
                    <option value="">Select Supplier</option>
                    <template x-for="supplier in suppliers" :key="supplier.id">
                        <option :value="supplier.id" x-text="supplier.name"></option>
                    </template>
                </select>
            </div>
            <!-- Purchase Date -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <label for="purchaseDate" class="form-label">Purchase Date</label>
                <input type="date" class="form-control form-control-sm" id="purchaseDate" x-model="purchaseDate">
            </div>
            <!-- Purchase Status -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <label for="purchaseStatus" class="form-label">Status</label>
                <select class="form-control form-select form-select-sm" id="purchaseStatus" x-model="purchaseStatus">
                    <option value="draft">Draft</option>
                    <option value="ordered">Ordered</option>
                    <option value="received">Received</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <!-- Payment Term -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <label for="paymentTerm" class="form-label">Payment Term</label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" x-model="paymentDays" min="0" placeholder="Days">
                    <span class="input-group-text">/</span>
                    <select class="form-control form-select form-select-sm" id="paymentMonths" x-model="paymentMonths">
                        <option value="month">Month</option>
                        <option value="days">Days</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Requisition Selection Modal -->
        <div class="modal fade" id="requisitionModal" tabindex="-1" aria-labelledby="requisitionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" x-data>
                    <div class="modal-header">
                        <h5 class="modal-title" id="requisitionModalLabel">Select a Requisition</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Search Input for Requisitions -->
                        <input type="text" class="form-control mb-3" placeholder="Search Requisitions..." x-model="requisitionSearchTerm">

                        <!-- Requisition List -->
                        <ul class="list-group">
                            <template x-for="requisition in filteredRequisitions()" :key="requisition.id">
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @click="selectRequisition(requisition); closeModal('requisitionModal')" type="button">
                                    <span x-text="'Requisition ' + requisition.id"></span>
                                    <span x-text="new Date(requisition.created_at).toLocaleString()"></span>
                                </li>
                            </template>
                            <li class="list-group-item text-center text-muted" x-show="filteredRequisitions().length === 0">
                                No requisitions found.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Selection Modal -->
        <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" x-data>
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalLabel">Select a Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Search Input -->
                        <input type="text" class="form-control mb-3" placeholder="Search Products..." x-model="searchTerm">

                        <!-- Product List -->
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>SKU</th>
                                        <th>Price</th>
                                        <th>Stock Quantity</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="product in filteredProducts()" :key="product.id">
                                        <tr>
                                            <td x-text="product.product.name"></td>
                                            <td x-text="product.sku"></td>
                                            <td x-text="product.price"></td>
                                            <td x-text="product.stock_quantity"></td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-primary" @click="selectProduct(product); closeModal('productModal')">
                                                    Add
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                    <!-- Display a message if no products are found -->
                                    <tr x-show="filteredProducts().length === 0">
                                        <td colspan="5" class="text-center text-muted">No products found.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="#" target="_blank" class="btn btn-sm btn-success">Create Product</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Order Table -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th colspan="10">Purchase Part</th>
                        <th class="sellinginfo text-center" colspan="3">Selling Part</th>
                        <th colspan="1"></th>
                    </tr>
                    <tr>
                        <th>Product Name</th>
                        <th>Current Stock</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Discount (%)</th>
                        <th>Tax</th>
                        
                        <th>Sub Total</th>
                        <th>Tax Amount</th>
                        <th>Net Cost</th>
                        <th>Line Total</th>
                        <th class="sellinginfo">Profit Margin (%)</th>
                        <th class="sellinginfo">Selling Price</th>
                        <th class="sellinginfo">Selling Tax</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(row, index) in rows" :key="index">
                        <tr>
                            <td>
                                <span x-text="row.productName"></span><br>
                                <small class="text-muted" x-text="row.productSKU"></small>
                            </td>
                            <td x-text="row.stock_quantity"></td>
                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.quantity" min="1" @input="onPriceOrDiscountChange(row)">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.price" step="0.01" @input="onPriceOrDiscountChange(row)">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.discount" step="0.01" @input="onPriceOrDiscountChange(row)">
                            </td>
                            <td>
                                <!-- Tax Dropdown for each row -->
                                <select class="form-select form-select-sm" x-model="row.selectedTax">
                                    <option value="" selected>Select Tax</option>
                                    <template x-for="tax in taxes" :key="tax.id">
                                        <option :value="tax.name">
                                            <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                                        </option>
                                    </template>
                                </select>
                            </td>
                          
                            <td>
                                <input type="text" class="form-control form-control-sm" :value="calculateSubTotal(row).toFixed(2)" readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" :value="calculateTaxAmount(row).toFixed(2)" readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" :value="calculateNetCost(row).toFixed(2)" readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" :value="calculateLineTotal(row).toFixed(2)" readonly>
                            </td>
                            <td class="sellinginfo">
                                <input type="number" class="form-control form-control-sm" x-model.number="row.profitMargin" step="0.01" min="0" max="100" @input="updateSellingPrice(row)">
                            </td>
                            <td class="sellinginfo">
                                <input type="number" class="form-control form-control-sm" x-model.number="row.sellingPrice" step="0.01" @input="updateProfitMargin(row)">
                            </td>
                            <td class="sellinginfo">
                                <!-- Selling Tax Dropdown for each row -->
                                <select class="form-select form-select-sm" x-model="row.selectedSellingTax">
                                    <option value="" selected>Select Selling Tax</option>
                                    <template x-for="tax in sellingTaxes" :key="tax.id">
                                        <option :value="tax.name">
                                            <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                                        </option>
                                    </template>
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" @click="removeRow(index)">
                                    <i class="bi bi-x"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tfoot>
                    <tr class="bg-white text-bold">
                        <td colspan="2" class="text-end">Totals</td>
                        <td>
                            <input type="text" class="form-control form-control-sm text-bold" :value="calculateTotalQuantity()" readonly>
                        </td>
                        <td colspan="9"></td>
                        <td>
                            <input type="text" class="form-control form-control-sm text-bold" :value="calculateTotalCost().toFixed(2)" readonly>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Additional Information Section -->
        <div class="col bg-white py-4">
            <h5>Shipping Info & Purchase Tax (If Any)</h5>
            <div class="row align-items-center mb-3 px-1">
                <div class="col-md-2">
                    <label for="purchaseTaxValue" class="form-label fw-bold">Purchase Tax</label>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="purchaseTaxValue" x-model="purchaseTaxValue">
                        <option value="" selected>Select Purchase Tax</option>
                        <template x-for="tax in taxes" :key="tax.id">
                            <option :value="tax.name">
                                <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                            </option>
                        </template>
                    </select>
                </div>
            </div>

            <!-- Shipping Information and Shipping Cost Inputs -->
            <div class="row px-1">
                <div class="col-md-4 mb-3">
                    <label for="shippingInfo" class="form-label">Shipping Info</label>
                    <input type="text" class="form-control" id="shippingInfo" x-model="shippingInfo" placeholder="Enter shipping details">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="shippingCost" class="form-label">Shipping Cost:</label>
                    <input type="number" class="form-control" id="shippingCost" x-model.number="shippingCost" step="0.01" placeholder="0.00">
                </div>
            </div>

            <!-- Global Discount Input Section -->
            <h5 class="my-2">Global Discount</h5>
            <div class="row px-1">
                <div class="col-md-2 mb-3">
                    <label for="globalDiscountType" class="form-label">Discount Type</label>
                    <select class="form-select mt-3" id="globalDiscountType" x-model="globalDiscountType">
                        <option value="percentage">Percentage</option>
                        <option value="flat">Flat</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="globalDiscountValue" class="form-label">Discount Value</label>
                    <input type="number" class="form-control" id="globalDiscountValue" x-model="globalDiscountValue" step="0.01" placeholder="0.00">
                </div>
            </div>

            <!-- Additional Costs (Key-Value Pairs) -->
            <h5 class="my-2">Additional Costs</h5>
            <div class="row px-1">
                <div class="col-md-6 mb-3">
                    <template x-for="(additionalCost, index) in additionalCosts" :key="index">
                        <div class="d-flex mb-2">
                            <input type="text" class="form-control me-2" x-model="additionalCost.key" placeholder="Cost Description">
                            <input type="number" class="form-control mx-2" x-model="additionalCost.value" step="0.01" placeholder="0.00">
                            <button type="button" class="btn btn-danger ms-2" @click="removeAdditionalCost(index)">Remove</button>
                        </div>
                    </template>
                    <button type="button" class="btn btn-outline-secondary" @click="addAdditionalCost()">Add Additional Cost</button>
                </div>
            </div>
        </div>

        <!-- Summary and Submission -->
        <div class="row border-top">
            <div class="col-md-5"></div>
            <div class="mt-4 p-3 col-md-7">
                <table class="table table-bordered bg-white rounded">
                    <tr>
                        <td><strong>Purchase Tax Cost:</strong></td>
                        <td class="text-end">
                            <span x-show="finalPurchaseTaxValue > 0" x-text="finalPurchaseTaxValue.toFixed(2)"></span>
                            <div x-show="finalPurchaseTaxValue === 0 || !finalPurchaseTaxValue" class="text-muted">No purchase tax added.</div>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Shipping Cost:</strong></td>
                        <td class="text-end">
                            <span x-show="parseFloat(shippingCost) > 0" x-text="parseFloat(shippingCost).toFixed(2)"></span>
                            <div x-show="parseFloat(shippingCost) === 0 || !shippingCost" class="text-muted">No shipping cost added.</div>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Additional Costs:</strong></td>
                        <td class="text-end">
                            <span x-show="calculateAdditionalCosts() > 0" x-text="calculateAdditionalCosts().toFixed(2)"></span>
                            <div x-show="calculateAdditionalCosts() === 0" class="text-muted">No additional costs added.</div>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Global Discount:</strong> <span x-text="`(${globalDiscountType === 'percentage' ? globalDiscountValue + '%' : 'Flat ' + globalDiscountValue})`"></span></td>
                        <td class="text-end">
                            <span x-show="finalGlobalDiscount > 0" class="text-danger" x-text="`- ${finalGlobalDiscount.toFixed(2)}`"></span>
                            <div x-show="finalGlobalDiscount === 0" class="text-muted">No global discount added.</div>
                        </td>
                    </tr>
                    <tr class="border-top">
                        <td><h4 class="text-success"><strong>Total Cost:</strong></h4></td>
                        <td class="text-end">
                            <h4 class="text-success"><span x-text="calculateFinalCost().toFixed(2)"></span></h4>
                        </td>
                    </tr>
                </table>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger d-flex align-items-center" @click="clearRows()">
                        <i class="bi bi-trash me-2"></i> Clear All
                    </button>
                    <button type="submit" class="btn btn-success d-flex align-items-center">
                        <i class="bi bi-check-circle me-2"></i> Submit Purchase Order
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Bootstrap JS Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js"></script>

<script>
function purchaseOrderForm() {
    return {
        // Data properties
        isEditMode: false, // Set to true if editing an existing PO
        purchaseOrderId: null, // Set to the ID of the PO being edited
        rows: [],
        products: [],
        searchTerm: '',
        requisitions: [],
        requisitionSearchTerm: '',
        purchaseTaxValue: '',  // Value of purchase tax
        finalPurchaseTaxValue: 0,
        shippingInfo: '',  // Shipping info field
        shippingCost: 0,  // Shipping cost field
        additionalCosts: [],
        taxes: [],
        sellingTaxes: [],
        selectedPurchaseTaxObject: null,
        globalDiscountType: 'percentage',  // Default to percentage
        globalDiscountValue: 0,
        finalGlobalDiscount: 0,
        suppliers: [],
        selectedSupplier: '',
        purchaseDate: '',
        purchaseStatus: 'draft',
        paymentDays: 0,
        paymentMonths: '',
        attachedDocument: null,
        selectedRequisition: null,
        init() {
            // Load initial data
            if (this.isEditMode) {
                // Fetch existing purchase order data
                this.fetchPurchaseOrderData();
            } else {
                // For adding new PO, load data from localStorage if available
                const savedData = JSON.parse(localStorage.getItem('purchaseOrderData'));
                if (savedData) {
                    this.rows = savedData.rows || [];
                    this.selectedSupplier = savedData.selectedSupplier || '';
                    this.purchaseDate = savedData.purchaseDate || '';
                    this.purchaseStatus = savedData.purchaseStatus || 'draft';
                    this.paymentDays = savedData.paymentDays || 0;
                    this.paymentMonths = savedData.paymentMonths || '';
                    this.purchaseTaxValue = savedData.purchaseTaxValue || '';
                    this.shippingInfo = savedData.shippingInfo || '';
                    this.shippingCost = parseFloat(savedData.shippingCost) || 0;
                    this.globalDiscountType = savedData.globalDiscountType || 'percentage';
                    this.globalDiscountValue = savedData.globalDiscountValue || 0;
                    this.additionalCosts = savedData.additionalCosts || [];
                    this.selectedRequisition = savedData.selectedRequisition || null;
                }
            }
            this.fetchSampleData(); // Load sample data
        },
        fetchSampleData() {
            // Sample data arrays
            this.suppliers = [
                { id: 1, name: 'Supplier A' },
                { id: 2, name: 'Supplier B' },
                { id: 3, name: 'Supplier C' },
            ];
            this.products = [
                {
                    id: 1,
                    sku: 'PROD001',
                    product: { name: 'Product 1' },
                    price: 100,
                    stock_quantity: 50,
                    profit_margin_percentage: 20,
                },
                {
                    id: 2,
                    sku: 'PROD002',
                    product: { name: 'Product 2' },
                    price: 150,
                    stock_quantity: 30,
                    profit_margin_percentage: 25,
                },
                {
                    id: 3,
                    sku: 'PROD003',
                    product: { name: 'Product 3' },
                    price: 200,
                    stock_quantity: 20,
                    profit_margin_percentage: 30,
                },
            ];
            this.taxes = [
                { id: 1, name: 'VAT', type: 'percentage', value: 15 },
                { id: 2, name: 'GST', type: 'percentage', value: 10 },
                { id: 3, name: 'Service Tax', type: 'flat', value: 50 },
            ];
            this.sellingTaxes = [
                { id: 1, name: 'Sales Tax', type: 'percentage', value: 8 },
                { id: 2, name: 'Luxury Tax', type: 'percentage', value: 12 },
                { id: 3, name: 'Special Tax', type: 'flat', value: 20 },
            ];
            this.requisitions = [
                { id: 1, created_at: '2023-10-01T10:00:00Z' },
                { id: 2, created_at: '2023-10-05T15:30:00Z' },
                { id: 3, created_at: '2023-10-10T12:00:00Z' },
            ];
        },
        fetchPurchaseOrderData() {
            // Fetch existing PO data for editing
            // Since this is a sample, we'll simulate fetching data
            const data = {
                supplier: { id: 1 },
                order_date: '2023-10-15',
                status: 'ordered',
                paymentDays: 30,
                paymentMonths: 'month',
                purchase_tax_name: 'VAT',
                shipping_info: 'Express Delivery',
                shipping_cost: 100,
                global_discount_type: 'percentage',
                global_discount_value: 5,
                additional_costs: [
                    { description: 'Packaging', amount: 50 },
                ],
                requisition: { id: 2 },
                items: [
                    {
                        variant: {
                            product: { name: 'Product 1' },
                            sku: 'PROD001',
                            stock_quantity: 50,
                            profit_margin_percentage: 20,
                        },
                        quantity_ordered: 10,
                        price_per_unit: 100,
                        discount: 0,
                        tax_model: { name: 'VAT' },
                        selling_tax_model: { name: 'Sales Tax' },
                    },
                    // Add more items if needed
                ],
            };
            // Map data to local properties
            this.selectedSupplier = data.supplier.id;
            this.purchaseDate = data.order_date;
            this.purchaseStatus = data.status;
            this.paymentDays = data.paymentDays;
            this.paymentMonths = data.paymentMonths;
            this.purchaseTaxValue = data.purchase_tax_name;
            this.shippingInfo = data.shipping_info;
            this.shippingCost = parseFloat(data.shipping_cost);
            this.globalDiscountType = data.global_discount_type;
            this.globalDiscountValue = parseFloat(data.global_discount_value);
            this.additionalCosts = data.additional_costs.map(cost => ({
                key: cost.description,
                value: parseFloat(cost.amount)
            }));
            this.selectedRequisition = data.requisition.id;
            this.rows = data.items.map(item => ({
                productName: item.variant.product.name,
                stock_quantity: item.variant.stock_quantity,
                productSKU: item.variant.sku,
                quantity: item.quantity_ordered,
                price: parseFloat(item.price_per_unit),
                discount: parseFloat(item.discount),
                selectedTax: item.tax_model ? item.tax_model.name : '',
                selectedSellingTax: item.selling_tax_model ? item.selling_tax_model.name : '',
                profitMargin: parseFloat(item.variant.profit_margin_percentage),
                sellingPrice: this.calculateSellingPriceForRow({
                    price: parseFloat(item.price_per_unit),
                    discount: parseFloat(item.discount),
                    profitMargin: parseFloat(item.variant.profit_margin_percentage),
                    selectedSellingTax: item.selling_tax_model ? item.selling_tax_model.name : '',
                }),
            }));
        },
        filteredProducts() {
            if (this.searchTerm === '') {
                return this.products;
            }
            return this.products.filter(product =>
                product.product.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                product.sku.toLowerCase().includes(this.searchTerm.toLowerCase())
            );
        },
        filteredRequisitions() {
            if (this.requisitionSearchTerm === '') {
                return this.requisitions;
            }
            return this.requisitions.filter(requisition =>
                requisition.id.toString().includes(this.requisitionSearchTerm)
            );
        },
        selectProduct(product) {
            const existingProductIndex = this.rows.findIndex(row => row.productSKU === product.sku);
            if (existingProductIndex !== -1) {
                // If SKU exists, increment the quantity of the existing product
                this.rows[existingProductIndex].quantity += 1;
                Swal.fire({
                    title: 'Product already added!',
                    text: `Quantity updated for SKU: ${product.sku}`,
                    icon: 'success',
                });
            } else {
                // If not, add the new product
                this.rows.push({
                    productName: product.product.name,
                    stock_quantity: product.stock_quantity,
                    productSKU: product.sku,
                    quantity: 1,
                    price: product.price,
                    discount: 0,
                    selectedTax: '',
                    selectedSellingTax: '',
                    profitMargin: product.profit_margin_percentage || 0,
                    sellingPrice: this.calculateSellingPriceForRow({
                        price: product.price,
                        discount: 0,
                        profitMargin: product.profit_margin_percentage || 0,
                        selectedSellingTax: '',
                    }),
                });
            }
            this.saveRowsToLocalStorage();
            this.searchTerm = '';
            this.closeModal('productModal');
        },
        selectRequisition(requisition) {
            // Simulate fetching requisition details
            const data = {
                id: requisition.id,
                items: [
                    {
                        variant: {
                            product: { name: 'Product 2' },
                            sku: 'PROD002',
                            stock_quantity: 30,
                            profit_margin_percentage: 25,
                            price: 150,
                        },
                        quantity: 5,
                    },
                    // Add more items if needed
                ],
            };
            this.selectedRequisition = requisition.id;
            data.items.forEach(item => {
                const existingProductIndex = this.rows.findIndex(row => row.productSKU === item.variant.sku);
                if (existingProductIndex !== -1) {
                    // If SKU exists, increment the quantity
                    this.rows[existingProductIndex].quantity += item.quantity;
                } else {
                    // Otherwise, add the new product to the list
                    this.rows.push({
                        productName: item.variant.product.name,
                        stock_quantity: item.variant.stock_quantity,
                        productSKU: item.variant.sku,
                        quantity: item.quantity,
                        price: item.variant.price,
                        discount: 0,
                        selectedTax: '',
                        selectedSellingTax: '',
                        profitMargin: item.variant.profit_margin_percentage || 0,
                        sellingPrice: this.calculateSellingPriceForRow({
                            price: item.variant.price,
                            discount: 0,
                            profitMargin: item.variant.profit_margin_percentage || 0,
                            selectedSellingTax: '',
                        }),
                    });
                }
            });
            Swal.fire({
                title: 'Requisition Imported!',
                text: `Products from Requisition ${requisition.id} have been added.`,
                icon: 'success',
            });
            this.saveRowsToLocalStorage();
            this.closeModal('requisitionModal');
        },
        calculateSellingPriceForRow(rowData) {
            // Calculate net cost after applying discount
            const netCost = rowData.price - ((rowData.price * rowData.discount) / 100);
        
            // Add profit margin to the net cost
            const profitAmount = (netCost * rowData.profitMargin) / 100;
            const grossSellingPrice = netCost + profitAmount;
        
            // Include selling tax
            let sellingTaxAmount = 0;
            if (rowData.selectedSellingTax) {
                const selectedTax = this.sellingTaxes.find(tax => tax.name === rowData.selectedSellingTax);
                if (selectedTax) {
                    if (selectedTax.type === 'percentage') {
                        sellingTaxAmount = (grossSellingPrice * selectedTax.value) / 100;
                    } else if (selectedTax.type === 'flat') {
                        sellingTaxAmount = selectedTax.value;
                    }
                }
            }
        
            // Final selling price = gross selling price + selling tax
            return grossSellingPrice + sellingTaxAmount;
        },
        calculateSubTotal(row) {
            return row.quantity * row.price;
        },
        calculateDiscountAmount(row) {
            return (this.calculateSubTotal(row) * row.discount) / 100;
        },
        calculateNetCost(row) {
            return this.calculateSubTotal(row) - this.calculateDiscountAmount(row);
        },
        calculateTaxAmount(row) {
            if (!row.selectedTax) {
                return 0;
            }
            const selectedTax = this.taxes.find(tax => tax.name === row.selectedTax);
            if (selectedTax) {
                if (selectedTax.type === 'percentage') {
                    return (this.calculateNetCost(row) * selectedTax.value) / 100;
                } else if (selectedTax.type === 'flat') {
                    return selectedTax.value;
                }
            }
            return 0;
        },
        calculateLineTotal(row) {
            return this.calculateNetCost(row) + this.calculateTaxAmount(row);
        },
        calculateTotalCost() {
            return this.rows.reduce((total, row) => total + this.calculateLineTotal(row), 0);
        },
        calculateTotalQuantity() {
            return this.rows.reduce((total, row) => total + (row.quantity || 1), 0);
        },
        calculateSellingTaxAmount(row, sellingPriceWithoutTax) {
            if (!row.selectedSellingTax) {
                return 0;
            }
            const selectedTax = this.sellingTaxes.find(tax => tax.name === row.selectedSellingTax);
            if (selectedTax) {
                if (selectedTax.type === 'percentage') {
                    return (sellingPriceWithoutTax * selectedTax.value) / 100;
                } else if (selectedTax.type === 'flat') {
                    return selectedTax.value;
                }
            }
            return 0;
        },
        updateSellingPrice(row) {
            // When profitMargin changes, update sellingPrice
            row.sellingPrice = this.calculateSellingPriceForRow({
                price: row.price,
                discount: row.discount,
                profitMargin: row.profitMargin,
                selectedSellingTax: row.selectedSellingTax,
            });
        },
        updateProfitMargin(row) {
            const netCost = this.calculateNetCost(row);
            if (netCost > 0) {
                const sellingTaxAmount = this.calculateSellingTaxAmount(row, row.sellingPrice);
                const grossSellingPrice = row.sellingPrice - sellingTaxAmount;
                row.profitMargin = ((grossSellingPrice - netCost) / netCost) * 100;
            } else {
                row.profitMargin = 0;
            }
        },
        onPriceOrDiscountChange(row) {
            // Update net cost
            const netCost = this.calculateNetCost(row);
        
            // Recalculate selling price based on updated price, discount, and profit margin
            row.sellingPrice = this.calculateSellingPriceForRow({
                price: row.price,
                discount: row.discount,
                profitMargin: row.profitMargin,
                selectedSellingTax: row.selectedSellingTax,
            });
        },
        addAdditionalCost() {
            this.additionalCosts.push({ key: '', value: 0 });
        },
        removeAdditionalCost(index) {
            this.additionalCosts.splice(index, 1);
        },
        calculateAdditionalCosts() {
            return this.additionalCosts.reduce((total, cost) => total + parseFloat(cost.value || 0), 0);
        },
        calculateFinalCost() {
            let subtotal = this.calculateTotalCost();

            // Apply purchase tax
            let purchaseTax = 0;
            const selectedTax = this.taxes.find(tax => tax.name === this.purchaseTaxValue);
            this.selectedPurchaseTaxObject = selectedTax;

            if (selectedTax) {
                if (selectedTax.type === 'percentage') {
                    purchaseTax = (subtotal * selectedTax.value) / 100;
                } else if (selectedTax.type === 'flat') {
                    purchaseTax = selectedTax.value;
                }
            }
            this.finalPurchaseTaxValue = purchaseTax;

            // Calculate total with tax, shipping, and additional costs
            let totalCost = subtotal + purchaseTax + parseFloat(this.shippingCost || 0) + this.calculateAdditionalCosts();

            // Apply global discount
            let globalDiscount = 0;
            if (this.globalDiscountType === 'percentage') {
                globalDiscount = (totalCost * this.globalDiscountValue) / 100;
            } else if (this.globalDiscountType === 'flat') {
                globalDiscount = parseFloat(this.globalDiscountValue || 0);
            }
            this.finalGlobalDiscount = globalDiscount;

            // Subtract the global discount from the total cost
            totalCost -= globalDiscount;

            this.saveRowsToLocalStorage();
            return totalCost;
        },
        removeRow(index) {
            if (this.rows.length >= 1) {
                this.rows.splice(index, 1);
                this.saveRowsToLocalStorage();
            }
        },
        saveRowsToLocalStorage() {
            const data = {
                selectedRequisition: this.selectedRequisition,
                rows: this.rows,
                selectedSupplier: this.selectedSupplier,
                purchaseDate: this.purchaseDate,
                purchaseStatus: this.purchaseStatus,
                paymentDays: this.paymentDays,
                paymentMonths: this.paymentMonths,
                purchaseTaxValue: this.purchaseTaxValue,
                shippingInfo: this.shippingInfo,
                shippingCost: this.shippingCost,
                globalDiscountType: this.globalDiscountType,
                globalDiscountValue: this.globalDiscountValue,
                additionalCosts: this.additionalCosts
            };
            localStorage.setItem('purchaseOrderData', JSON.stringify(data));
        },
        clearRows() {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will clear all rows and cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, clear it!',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    // If confirmed, clear rows and remove from localStorage
                    this.rows = [];
                    localStorage.removeItem('purchaseOrderData');
                    Swal.fire(
                        'Cleared!',
                        'Your rows have been cleared.',
                        'success'
                    );
                }
            });
        },
        submitForm() {
            if (this.rows.length <= 0) {
                Swal.fire({
                    title: 'You must add at least one product.',
                    icon: 'error',
                });
                return;
            }

            // Prepare the payload
            const payload = {
                requisition: this.selectedRequisition,
                supplier: this.selectedSupplier,
                order_date: this.purchaseDate,
                status: this.purchaseStatus,
                paymentDays: this.paymentDays,
                paymentMonths: this.paymentMonths,
                purchase_tax_name: this.selectedPurchaseTaxObject?.name || '',
                purchase_tax_id: this.selectedPurchaseTaxObject?.id || null,
                purchase_tax_type: this.selectedPurchaseTaxObject?.type || '',
                purchase_tax_value: this.selectedPurchaseTaxObject?.value || 0,
                shipping_info: this.shippingInfo,
                shipping_cost: this.shippingCost,
                global_discount_type: this.globalDiscountType,
                global_discount_value: this.globalDiscountValue,
                additional_costs: this.additionalCosts,
                items: this.rows.map(row => ({
                    variant: row.productSKU,
                    quantity_ordered: row.quantity,
                    price_per_unit: row.price,
                    discount: row.discount,
                    tax: row.selectedTax ? this.taxes.find(tax => tax.name === row.selectedTax).id : null,
                    selling_tax: row.selectedSellingTax ? this.sellingTaxes.find(tax => tax.name === row.selectedSellingTax).id : null,
                    profit_margin_percentage: row.profitMargin,
                    expected_selling_price: row.sellingPrice,
                })),
            };

            // For this example, we'll just log the payload
            console.log('Purchase Order Payload:', payload);
            Swal.fire({
                title: 'Purchase order submitted successfully!',
                icon: 'success',
            });
        },
        closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        },
    };
}
</script>
</body>
</html>
