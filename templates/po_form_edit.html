{% extends 'includes/main.html' %}
{% load static %}

{% block content %}
    <div class="container-fluid bg-light p-5 shadow-sm rounded mb-5 mx-5"
         x-data="purchaseOrderForm('{{ purchase_order_id|default:'' }}')" x-init="init()">
        <h3 class="mb-4 text-primary">Purchase Order Form: Requisition ID # <span x-text="selectedRequisition"></span>
        </h3>

        <form @submit.prevent="submitForm()">
            {% csrf_token %}


            <!-- Add Product Button -->
            <div class="d-flex justify-content-between align-items-center mb-4">

                <!-- Button to Open Requisition Modal -->
                {% comment %} <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#requisitionModal"
                    :disabled="isEditing">
                <i class="bi bi-folder"></i> Import from Requisition
            </button> {% endcomment %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                    <i class="bi bi-plus-circle"></i> Add Product
                </button>
            </div>


            <div class="row g-2 mb-6 py-4 bg-white">


                <!-- Supplier Dropdown -->
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label for="supplier" class="form-label">Supplier</label>
                    <select class="form-control form-select form-select-sm"
                            id="supplier"
                            x-model="selectedSupplier"
                            @change="saveRowsToLocalStorage()">
                        <option value="">Select Supplier</option>
                        <template x-for="supplier in suppliers" :key="supplier.id">
                            <option :value="supplier.id" x-text="supplier.name"
                                    :selected="supplier.id == selectedSupplier"></option>
                        </template>
                    </select>
                </div>


                <!-- Purchase Date -->
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label for="expected_delivery_date" class="form-label">Purchase Date</label>
                    <input type="date" class="form-control form-control-sm" id="expected_delivery_date"
                           x-model="expected_delivery_date" @change="saveRowsToLocalStorage()">
                </div>

                <!-- Purchase Status -->
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <label for="purchaseStatus" class="form-label">Status</label>
                    <select class="form-control form-select form-select-sm" id="purchaseStatus"
                            x-model="purchaseStatus">


                        <option value="received">Received</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>


                    </select>
                </div>

                <!-- Payment Term (Days and Months) -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <label for="paymentTerm" class="form-label">Payment Term</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" x-model="paymentDays" min="0" placeholder="">
                        <span class="input-group-text">/</span>


                        <select class="form-control form-select form-select-sm" id="paymentMonths"
                                x-model="paymentMonths">
                            <option value="month">Month</option>
                            <option value="days">Days</option>

                        </select>
                    </div>
                </div>

                <!-- Attach Documents -->
                <div class="col-lg-3 col-md-5 col-sm-6">
                    <label for="attachment" class="form-label">Attach Document</label>
                    <input type="file" class="form-control form-control-sm" id="attachment" @change="handleFileUpload">
                </div>

            </div>


            <!-- Requisition Selection Modal -->
            <div class="modal fade" id="requisitionModal" tabindex="-1" aria-labelledby="requisitionModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="requisitionModalLabel">Select a Requisition</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Search Input for Requisitions -->
                            <input type="text" class="form-control mb-3" placeholder="Search Requisitions..."
                                   x-model="requisitionSearchTerm" @input.debounce.500="fetchRequisitions">

                            <!-- Requisition List -->
                            <ul class="list-group">
                                <template x-for="requisition in filteredRequisitions()" :key="requisition.id">
                                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                        @click="selectRequisition(requisition)" data-bs-dismiss="modal" type="button">
                                        <span x-text="'Requisition ' + requisition.id"></span>
                                        <span x-text="new Date(requisition.created_at).toLocaleString()"></span>
                                    </li>
                                </template>
                                <li class="list-group-item text-center text-muted"
                                    x-show="filteredRequisitions().length === 0">
                                    No requisitions found.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Selection Modal -->
            <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="productModalLabel">Select a Product</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Search Input -->
                            <input type="text" class="form-control mb-3" placeholder="Search Products..."
                                   x-model="searchTerm" @input.debounce.500="fetchVariants">

                            <!-- Product List -->
                            <ul class="list-group">
                                <template x-for="product in filteredProducts()" :key="product.id">
                                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                        @click="selectProduct(product)" data-bs-dismiss="modal" type="button">
                                        <span x-text="`${product.product.name} [${product.sku}]`"></span>


                                        <span class="badge bg-primary text-white">$<span x-text="product.price"></span></span>
                                    </li>
                                </template>
                                <!-- Display a message if no products are found -->
                                <li class="list-group-item text-center text-muted"
                                    x-show="filteredProducts().length === 0">
                                    No products found.
                                </li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <a href="{% url 'product_add' %}" target="_blank" type="button"
                               class="btn btn-sm btn-success"> Create Product</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Order Table -->
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th colspan="10">Purchase Section</th>
                        <th class="sellinginfo text-center" colspan="3">Selling Section</th>
                        <th colspan="1"></th>
                    </tr>
                    <tr>
                        <!-- Table Headings -->
                        <th width="10%">Product Name</th>
                        <th>Current Stock</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Discount (%)</th>
                        <th>Tax (%)</th>
                        <th>Sub Total</th>
                        <th>Tax Amount</th>
                        <th>Net Cost</th>
                        <th>Line Total</th>
                        <th class="sellinginfo">Profit Margin (%)</th>
                        <th class="sellinginfo">Selling Price</th>
                        <th class="sellinginfo">Selling Tax</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="(row, index) in rows" :key="index">
                        <tr>
                            <td>
                                <span class="d-inline-block" x-text="row.productName"></span> <br>
                                <small class="text-bold">
                                    <span class="d-inline-block" x-text="row.productSKU"></span> </small>
                            </td>

                            <td>
                                <span class="d-inline-block" x-text="row.stock_quantity"></span>
                            </td>


                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.quantity"
                                       min="1">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.price"
                                       step="0.01">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" x-model.number="row.discount"
                                       step="0.01">
                            </td>
                            <td>

                                <!-- Tax Dropdown for each row -->
                                <select class="form-select form-select-sm" x-model="row.selectedTax"
                                        @change="saveRowsToLocalStorage()">
                                    <option value="" selected>Select Tax</option>
                                    <template x-for="tax in taxes" :key="tax.name">
                                        <option :value="tax.name"
                                                :selected="row.selectedTax === tax.name">
                                            <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                                        </option>
                                    </template>
                                </select>

                            </td>


                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       :value="calculateSubTotal(row).toFixed(2)" readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       :value="calculateTaxAmount(row).toFixed(2)"
                                       readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       :value="calculateNetCost(row).toFixed(2)"
                                       readonly>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm"
                                       :value="calculateLineTotal(row).toFixed(2)"
                                       readonly>
                            </td>
                            <td class="sellinginfo">
                                <input type="number" class="form-control form-control-sm"
                                       x-model.number="row.profitMargin" step="0.01" min="0" max="100"
                                       @input="updateSellingPrice(row)">
                            </td>
                            <td class="sellinginfo">
                                <input type="number" class="form-control form-control-sm"
                                       x-model.number="row.sellingPrice" step="0.01" @input="updateProfitMargin(row)">
                            </td>
                            <td class="sellinginfo">
                                <select class="form-select form-select-sm" x-model="row.selectedSellingTax"
                                        @change="saveRowsToLocalStorage()">
                                    <option value="" selected>Select Tax</option>
                                    <template x-for="tax in taxes" :key="tax.name">
                                        <option :value="tax.name" :selected="row.selectedSellingTax === tax.name">
                                            <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                                        </option>
                                    </template>
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" @click="removeRow(index)">
                                    <i class="fa fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                    <tfoot>
                    <tr class="bg-white text-bold">
                        <td colspan="2" class="text-end text-bold">Total Line

                        </td>

                        <td colspan="1">

                            Total Quantity
                            <input type="text" class="form-control form-control-sm text-bold"
                                   :value="calculateTotalQuantity()" readonly>
                        </td>
                        <td colspan="1">
                            Total Unit Cost
                            <input type="text" class="form-control form-control-sm text-bold"
                                   :value="calculateTotalPriceWithoutDiscountTax()" readonly>

                        </td>
                        <td colspan="5">

                        </td>
                        <td>
                            Total Cost
                            <input type="text" class="form-control form-control-sm text-bold"
                                   :value="calculateTotalCost().toFixed(2)" readonly>
                        </td>
                        <td colspan="4"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Purchase Tax Input -->

            <div class="col bg-white py-4">
                <h5>Shipping Info & Purchase Tax (If Any)</h5>
                <div class="row align-items-center mb-3 px-1">
                    <div class="col-md-2">
                        <label for="purchaseTaxValue" class="form-label fw-bold">Purchase Tax</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">

                            <select class="form-select" id="purchaseTaxValue" x-model="purchaseTaxValue">
                                <option value="" selected>Select Purchase Tax</option>
                                <template x-for="tax in taxes" :key="tax.name">
                                    <option :value="tax.name" :selected="tax.name === purchaseTaxValue">
                                        <span x-text="`${tax.name} (${tax.type === 'percentage' ? tax.value + '%' : 'Flat ' + tax.value})`"></span>
                                    </option>
                                </template>
                            </select>

                        </div>
                    </div>
                </div>


                <!-- Shipping Information and Shipping Cost Inputs -->
                <div class="row px-1">
                    <div class="col-md-2 mb-3">
                        <label for="shippingInfo" class="form-label">Shipping Info</label>
                        <input type="text" class="form-control" id="shippingInfo" x-model="shippingInfo"
                               placeholder="Enter shipping details">
                    </div>

                    <div class="col-md-2 mb-3">
                        <label for="shippingCost" class="form-label">Shipping Cost: </label>
                        <input type="number" class="form-control" id="shippingCost" x-model="shippingCost" step="0.01"
                               placeholder="0.00">
                    </div>
                </div>

                <!-- Global Discount Input Section -->
                <h5 class="my-2">Global Discount</h5>
                <div class="row px-1">
                    <div class="col-md-2 mb-3">
                        <label for="globalDiscountType" class="form-label">Discount Type</label>
                        <select class="form-select mt-3" id="globalDiscountType" x-model="globalDiscountType">
                            <option value="percentage">Percentage</option>
                            <option value="flat">Flat</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="globalDiscountValue" class="form-label">Discount Value</label>
                        <input type="number" class="form-control" id="globalDiscountValue" x-model="globalDiscountValue"
                               step="0.01" placeholder="0.00">
                    </div>
                </div>


                <!-- Additional Costs (Key-Value Pairs) -->
                <h5 class="my-2">Additional Costs</h5>
                <div class="row px-1">
                    <div class="col-md-4 mb-3">

                        <template x-for="(additionalCost, index) in additionalCosts" :key="index">
                            <div class="d-flex mb-2">
                                <input type="text" class="form-control me-2" x-model="additionalCost.key"
                                       placeholder="Cost Description">
                                <input type="number" class="form-control mx-2" x-model="additionalCost.value"
                                       step="0.01" placeholder="0.00">
                                <button type="button" class="btn btn-danger ms-2" @click="removeAdditionalCost(index)">
                                    Remove
                                </button>
                            </div>
                        </template>
                        <button type="button" class="btn btn-outline-secondary" @click="addAdditionalCost()">Add
                            Additional Cost
                        </button>
                    </div>
                </div>

            </div>


            <!-- Form Buttons -->
            <div class="row border-top">
                <div class="col-md-5"></div>
                <div class="mt-4 p-3  col-md-7">
                    <table class="table table-bordered bg-white rounded">
                        <tr>
                            <td><strong>Purchase Tax Cost:


                                <span x-show="selectedPurchaseTaxObject"
                                      x-text="selectedPurchaseTaxObject ? `${selectedPurchaseTaxObject.name} (${selectedPurchaseTaxObject.type === 'percentage' ? selectedPurchaseTaxObject.value + '%' : 'Flat ' + selectedPurchaseTaxObject.value})` : 'No tax selected'">
                        </span>


                            </strong></td>
                            <td class="text-end">
                                <span x-show="finalPurchaseTaxValue > 0"
                                      x-text="finalPurchaseTaxValue.toFixed(2)"></span>

                                <div x-show="finalPurchaseTaxValue === 0" class="text-muted">
                                    No purchase tax added.
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Shipping Cost: <span x-text='shippingInfo'></span></strong></td>
                            <td class="text-end">
                                <span x-text="shippingCost" x-show="shippingCost >  0"></span>
                                <div x-show="shippingCost === 0" class="text-muted">
                                    No shipping cost added.
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Additional Cost:</strong>

                            </td>


                            <td class="text-end">
                                <table class="table table-sm table-striped  table-bordered mb-0"
                                       x-show="additionalCosts.length>0">
                                    <thead>
                                    <tr>
                                        <th>Cost Description</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <template x-for="aCost in additionalCosts" :key="aCost.key">
                                        <tr>
                                            <td><span x-text="aCost.key"></span></td>
                                            <td class="text-end"><span
                                                    x-text="parseFloat(aCost.value).toFixed(2)"></span></td>
                                        </tr>
                                    </template>
                                    <!-- Total row -->
                                    <tr>
                                        <td><strong>Total:</strong></td>
                                        <td class="text-end"><strong><span
                                                x-text="calculateAdditionalCosts().toFixed(2)"></span></strong></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <div x-show="additionalCosts.length === 0" class="text-muted">
                                    No additional costs added.
                                </div>
                            </td>


                        </tr>
                        <tr>
                            <td>Global Discount: <span
                                    x-text="`(${globalDiscountType === 'percentage' ? globalDiscountValue + '%' : 'Flat ' + globalDiscountValue})`"></span>
                            </td>
                            <td>

                                <span class="text-danger" x-show="finalGlobalDiscount > 0"
                                      x-text="`- ${finalGlobalDiscount}`"></span>

                                <div x-show="finalGlobalDiscount === 0" class="text-muted">
                                    No global discount added.
                                </div>
                            </td>
                        </tr>
                        <tr class="border-top">
                            <td><h4 class="text-success"><strong>Total Cost:</strong></h4></td>
                            <td class="text-end">
                                <h4 class="text-success"><span x-text="calculateFinalCost().toFixed(2)"></span></h4>
                            </td>
                        </tr>
                    </table>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-danger d-flex align-items-center"
                                @click="clearRows()">
                            <i class="bi bi-trash me-2"></i> Clear All
                        </button>


                        <button type="submit" class="btn btn-success d-flex align-items-center mt-2">
                            <i class="bi bi-check-circle me-2"></i> Submit Purchase Order
                        </button>
                    </div>
                </div>
            </div>


        </form>

        <!-- JSON Output -->
        <div x-show="showJSON" class="mt-5 p-4 bg-white rounded shadow-sm">
            <h4 class="text-secondary">Form Data in JSON</h4>
            <pre class="bg-light p-3 rounded" x-text="jsonOutput"></pre>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function purchaseOrderForm(purchaseOrderId) {  // Accept purchaseOrderId as a parameter
            return {
                purchaseOrderId: purchaseOrderId || null,
                isEditing: purchaseOrderId != null,
                rows: [],
                products: [],
                searchTerm: '',
                requisitions: [],
                requisitionSearchTerm: '',
                purchaseTaxValue: '',  // Use name for tax selection
                purchaseTaxType: 'percentage',
                finalPurchaseTaxValue: 0,
                shippingInfo: '',
                shippingCost: 0,
                additionalCosts: [],
                taxes: [],
                selectedPurchaseTaxObject: null,
                globalDiscountType: 'percentage',
                globalDiscountValue: 0,
                finalGlobalDiscount: 0,
                suppliers: [],
                selectedSupplier: '',
                purchaseDate: '',
                expected_delivery_date: '',
                purchaseStatus: 'draft',
                paymentDays: 0,
                paymentMonths: 'days',  // Adjusted to default to 'days'
                attachedDocument: null,
                selectedRequisition: null,

                init() {
                    // Fetch taxes and suppliers first
                    Promise.all([this.fetchTaxes(), this.fetchSuppliers()])
                        .then(() => {
                            if (this.isEditing) {
                                // Fetch existing purchase order data
                                fetch(`/api/v1/purchase-orders/${this.purchaseOrderId}/`)
                                    .then(response => response.json())
                                    .then(data => {
                                        this.loadPurchaseOrderData(data);
                                    })
                                    .catch(error => {
                                        console.error('Error fetching purchase order:', error);
                                    });
                            } else {
                                // Existing init code for creating a new purchase order
                                this.fetchVariants();
                                this.fetchRequisitions();
                                // Load saved data if any
                                // const savedData = JSON.parse(localStorage.getItem('purchaseOrderData'));
                                // if (savedData) {
                                //     this.loadSavedData(savedData);
                                // }
                            }
                        });
                },

                loadSavedData(savedData) {
                    this.rows = savedData.rows || [];
                    this.selectedSupplier = parseInt(savedData.selectedSupplier) || '';
                    this.purchaseDate = savedData.purchaseDate || '';
                    this.purchaseStatus = savedData.purchaseStatus || 'draft';
                    this.paymentDays = savedData.paymentDays || 0;
                    this.paymentMonths = savedData.paymentMonths || 'days';
                    this.purchaseTaxValue = savedData.purchaseTaxValue || '';
                    this.shippingInfo = savedData.shippingInfo || '';
                    this.shippingCost = savedData.shippingCost || 0;
                    this.globalDiscountType = savedData.globalDiscountType || 'percentage';
                    this.globalDiscountValue = savedData.globalDiscountValue || 0;
                    this.additionalCosts = savedData.additionalCosts || [];
                    this.selectedRequisition = savedData.selectedRequisition || null;
                },

                fetchRequisitions() {
                    fetch(`/api/v1/requisitions/?id=${this.requisitionSearchTerm}`)
                        .then(response => response.json())
                        .then(data => {
                            this.requisitions = data.results;
                        })
                        .catch(error => {
                            console.error('Error fetching requisitions:', error);
                        });
                },

                fetchVariants() {
                    fetch(`/api/v1/variants/?search=${this.searchTerm}`)
                        .then(response => response.json())
                        .then(data => {
                            this.products = data.results;
                        })
                        .catch(error => {
                            console.error('Error fetching variants:', error);
                        });
                },

                fetchTaxes() {
                    return fetch('/api/v1/tax/?limit=10000')
                        .then(response => response.json())
                        .then(data => {
                            this.taxes = data.results.filter(tax => tax.is_active)
                                .map(tax => ({
                                    id: tax.id,
                                    name: tax.name,
                                    type: tax.tax_type,
                                    value: parseFloat(tax.value)
                                }));
                        })
                        .catch(error => console.error('Error fetching taxes:', error));
                },

                fetchSuppliers() {
                    return fetch('/api/v1/supplier/?limit=10000')
                        .then(response => response.json())
                        .then(data => {
                            this.suppliers = data.results;
                        })
                        .catch(error => console.error('Error fetching suppliers:', error));
                },

                filteredProducts() {
                    return this.products;
                },

                selectRequisition(requisition) {
                    fetch(`/api/v1/requisitions/${requisition.id}/`)
                        .then(response => response.json())
                        .then(data => {
                            this.selectedRequisition = requisition.id;
                            let already_added = [];
                            // Append each item to the existing rows
                            data.items.forEach(item => {
                                const existingProductIndex = this.rows.findIndex(row => row.productSKU === item.variant.sku);
                                if (existingProductIndex !== -1) {
                                    // If SKU exists, increment the quantity
                                    this.rows[existingProductIndex].quantity += item.quantity;
                                    already_added.push(item.variant.sku);
                                } else {
                                    // Otherwise, add the new product to the list
                                    this.rows.push({
                                        productName: item.variant.product.name,
                                        stock_quantity: item.variant.stock_quantity,
                                        productSKU: item.variant.sku,
                                        quantity: item.quantity,
                                        price: parseFloat(item.variant.price),
                                        discount: 0,
                                        selectedTax: '',  // Initialize with empty string
                                    });
                                }
                            });

                            if (already_added.length > 0) {
                                Swal.fire({
                                    title: 'Some Products already added!',
                                    html: `Quantity updated for SKUs: ${already_added.join(', ')}`,
                                    icon: 'success',
                                });
                            }
                            this.saveRowsToLocalStorage();
                        })
                        .catch(error => {
                            console.error('Error fetching requisition details:', error);
                        });
                },

                filteredRequisitions() {
                    return this.requisitions;
                },

                selectProduct(product) {
                    const existingProductIndex = this.rows.findIndex(row => row.productSKU === product.sku);
                    if (existingProductIndex !== -1) {
                        // If SKU exists, increment the quantity of the existing product
                        this.rows[existingProductIndex].quantity += 1;
                        Swal.fire({
                            title: 'Product already added!',
                            text: `Quantity updated for SKU: ${product.sku}`,
                            icon: 'success',
                        });
                    } else {
                        // If not, add the new product
                        this.rows.push({
                            productName: product.product.name,
                            stock_quantity: product.stock_quantity,
                            productSKU: product.sku,
                            quantity: 1,
                            price: product.price,
                            discount: 0,
                            selectedTax: '',
                        });
                    }

                    this.saveRowsToLocalStorage();
                    this.searchTerm = '';
                    this.fetchVariants();
                },

                showJSON: false,
                jsonOutput: '',

                addRow() {
                    this.rows.push({
                        productName: '',
                        quantity: 1,
                        price: 0,
                        discount: 0,
                        selectedTax: '',
                    });
                },

                removeRow(index) {
                    if (this.rows.length >= 1) {
                        this.rows.splice(index, 1);
                        this.saveRowsToLocalStorage();
                    }
                },

                calculateSubTotal(row) {
                    return row.quantity * row.price;
                },

                calculateDiscountAmount(row) {
                    return (this.calculateSubTotal(row) * row.discount) / 100;
                },

                calculateNetCost(row) {
                    return this.calculateSubTotal(row) - this.calculateDiscountAmount(row);
                },

                calculateTaxAmount(row) {
                    if (!row.selectedTax) {
                        return 0; // Default tax amount is 0 when no tax is selected
                    }
                    // Find the selected tax object
                    const selectedTax = this.taxes.find(tax => tax.name === row.selectedTax);

                    if (selectedTax) {
                        if (selectedTax.type === 'percentage') {
                            return (this.calculateNetCost(row) * selectedTax.value) / 100;
                        } else if (selectedTax.type === 'flat') {
                            return selectedTax.value;
                        }
                    }
                    return 0; // If no valid tax is found, default to 0
                },

                calculateLineTotal(row) {
                    return this.calculateNetCost(row) + this.calculateTaxAmount(row);
                },

                calculateTotalCost() {
                    this.saveRowsToLocalStorage();
                    return this.rows.reduce((total, row) => total + this.calculateLineTotal(row), 0);
                },

                calculateTotalQuantity() {
                    return this.rows.reduce((total, row) => total + (row.quantity || 1), 0);
                },

                calculateTotalPriceWithoutDiscountTax() {
                    return this.rows.reduce((total, row) => total + (parseFloat(row.price) || 0), 0);
                },

                getTaxId(taxName) {
                    // First check if taxName exists
                    if (!taxName) return null;

                    // Find the matching tax in the taxes array
                    const tax = this.taxes.find(t => t.name === taxName);

                    // Return the ID if found, otherwise return null
                    return tax ? tax.id : null;
                },
                calculateSellingPriceForRow(rowData) {
                    // Calculate net cost after applying discount
                    const netCost = rowData.price - ((rowData.price * rowData.discount) / 100);

                    // Add profit margin to the net cost
                    const profitAmount = (netCost * rowData.profitMargin) / 100;
                    const grossSellingPrice = netCost + profitAmount;

                    // Final selling price = gross selling price + selling tax (if applicable)
                    return grossSellingPrice;
                },
                updateSellingPrice(row) {
                    // Update selling price based on profit margin
                    row.sellingPrice = this.calculateSellingPriceForRow({
                        price: row.price,
                        discount: row.discount,
                        profitMargin: row.profitMargin,
                        selectedSellingTax: row.selectedSellingTax,
                    });
                },
                updateProfitMargin(row) {
                    // Update profit margin based on selling price
                    const netCost = this.calculateNetCost(row);
                    if (netCost > 0) {
                        const sellingTaxAmount = 0; // Adjust if selling tax needs to be considered
                        const grossSellingPrice = row.sellingPrice - sellingTaxAmount;
                        row.profitMargin = ((grossSellingPrice - netCost) / netCost) * 100;
                    } else {
                        row.profitMargin = 0;
                    }
                },


                loadPurchaseOrderData(data) {
                    // Map main fields
                    this.selectedRequisition = data.requisition;
                    this.selectedSupplier = data.supplier;
                    this.expected_delivery_date = data.expected_delivery_date;
                    this.purchaseStatus = data.status;
                    this.globalDiscountType = data.global_discount_type;
                    this.globalDiscountValue = data.global_discount_value;
                    this.shippingInfo = data.shipping_info;
                    this.shippingCost = parseFloat(data.shipping_cost);
                    this.purchaseTaxValue = data.purchase_tax_name;
                    this.paymentMonths = data.paymentMonths;
                    this.paymentDays = data.paymentDays;

                    // Find the selected purchase tax object
                    this.selectedPurchaseTaxObject = this.taxes.find(tax => tax.name === data.purchase_tax_name);

                    // Map additional costs
                    this.additionalCosts = (data.additional_costs || []).map(cost => ({
                        key: cost.key,
                        value: parseFloat(cost.value)
                    }));

                    // Map items to rows
                    this.rows = data.items.map(item => {
                        // Find tax object by ID
                        const taxName = item.tax_model ? item.tax_model.name : '';
                        const sellingtaxName = item.selling_tax_model ? item.selling_tax_model.name : '';

                        return {
                            productSKU: item.variant.sku,
                            quantity: item.quantity_ordered,
                            price: parseFloat(item.price_per_unit),
                            discount: parseFloat(item.discount),

                            productName: item.variant.product.name,  // Placeholder, will fetch later
                            stock_quantity: item.variant.stock_quantity,  // Placeholder, will fetch later
                            selectedTax: taxName,

                            selectedSellingTax: sellingtaxName,
                            profitMargin: parseFloat(item.profit_margin_percentage) || 0,
                            sellingPrice: parseFloat(item.expected_selling_price) || 0,


                        };
                    });

                    // // Fetch variant data for each row to get productName and stock_quantity
                    // const variantPromises = this.rows.map((row, index) => {
                    //     return fetch(`/api/v1/variants/${row.productSKU}/`)
                    //         .then(response => response.json())
                    //         .then(variantData => {
                    //             this.rows[index].productName = variantData.product.name;
                    //             this.rows[index].stock_quantity = variantData.stock_quantity;
                    //         })
                    //         .catch(error => {
                    //             console.error(`Error fetching variant data for SKU ${row.productSKU}:`, error);
                    //         });
                    // });

                    // // Wait for all variant data to be loaded before proceeding (optional)
                    // Promise.all(variantPromises).then(() => {
                    //     // You can perform additional actions here if needed
                    //     this.saveRowsToLocalStorage(); // Save the loaded data to localStorage
                    // });
                },

                submitForm() {
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    if (this.rows.length <= 0) {
                        Swal.fire({
                            title: 'You must add at least one product line',
                            icon: 'error',
                        });
                        return;
                    }

                    if (!this.selectedRequisition) {
                        Swal.fire({
                            title: 'You must select/import an approved requisition',
                            icon: 'error',
                        });
                        return;
                    }

                    if (!this.selectedSupplier) {
                        Swal.fire({
                            title: 'You must select a supplier',
                            icon: 'error',
                        });
                        return;
                    }

                    // Prepare the payload
                    const payload = {
                        requisition: this.selectedRequisition,
                        supplier: this.selectedSupplier,

                        expected_delivery_date: this.expected_delivery_date,
                        status: this.purchaseStatus,
                        notes: this.notes,
                        global_discount_type: this.globalDiscountType,
                        global_discount_value: this.globalDiscountValue,
                        shipping_info: this.shippingInfo,
                        shipping_cost: this.shippingCost,
                        purchase_tax_name: this.selectedPurchaseTaxObject?.name || '',
                        purchase_tax_id: this.selectedPurchaseTaxObject?.name ? this.getTaxId(this.selectedPurchaseTaxObject?.name) : null,
                        purchase_tax_type: this.selectedPurchaseTaxObject?.type || '',
                        purchase_tax_value: this.selectedPurchaseTaxObject?.value || 0,
                        items: this.rows.map(row => ({
                            variant: row.productSKU,
                            quantity_ordered: row.quantity,
                            price_per_unit: row.price,
                            discount: row.discount,
                            tax: row.selectedTax ? this.getTaxId(row.selectedTax) : null,
                            selling_tax: row.selectedSellingTax ? this.getTaxId(row.selectedSellingTax) : null,
                            profit_margin_percentage: row.profitMargin,
                            expected_selling_price: row.sellingPrice,
                        })),
                        additional_costs: this.additionalCosts.map(cost => ({
                            description: cost.key,
                            amount: cost.value
                        }))
                    };

                    // Determine URL and method
                    let url = '/api/v1/purchase-order/create/';
                    let method = 'POST';

                    if (this.isEditing) {
                        url = `/api/v1/purchase-order/${this.purchaseOrderId}/update/`;
                        method = 'PUT';
                    }

                    fetch(url, {
                        method: method,
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                        body: JSON.stringify(payload)
                    })
                        .then(response => {
                            if (!response.ok) {
                                // If response is not OK, read the error message and throw it
                                return response.json().then(errData => {
                                    let errorMessage = errData.error || 'Unknown error occurred';
                                    throw new Error(errorMessage);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Purchase order saved:', data);
                            Swal.fire({
                                title: 'Purchase order saved successfully!',
                                icon: 'success',
                            }).then(() => {
                                // Redirect to purchase order list or detail page if needed
                                window.location.href = '/inventory/list-purchases/';
                            });
                        })
                        .catch(error => {
                            console.error('Error saving purchase order:', error);
                            Swal.fire({
                                title: 'Failed to save purchase order',
                                text: error.message,
                                icon: 'error',
                            });
                        });
                },

                saveRowsToLocalStorage() {
                    // const data = {
                    //     selectedRequisition: this.selectedRequisition,
                    //     rows: this.rows,
                    //     selectedSupplier: this.selectedSupplier,
                    //     purchaseDate: this.purchaseDate,
                    //     purchaseStatus: this.purchaseStatus,
                    //     paymentDays: this.paymentDays,
                    //     paymentMonths: this.paymentMonths,
                    //     purchaseTaxValue: this.purchaseTaxValue,
                    //     shippingInfo: this.shippingInfo,
                    //     shippingCost: this.shippingCost,
                    //     globalDiscountType: this.globalDiscountType,
                    //     globalDiscountValue: this.globalDiscountValue,
                    //     additionalCosts: this.additionalCosts
                    // };
                    // localStorage.setItem('purchaseOrderData', JSON.stringify(data));
                },

                clearRows() {
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "This will clear all rows and cannot be undone!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, clear it!',
                        cancelButtonText: 'No, keep it'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // If confirmed, clear rows and remove from localStorage
                            this.rows = [];
                            localStorage.removeItem('purchaseOrderData');
                            Swal.fire(
                                'Cleared!',
                                'Your rows have been cleared.',
                                'success'
                            );
                        }
                    });
                },

                // Add additional cost key-value pair
                addAdditionalCost() {
                    this.additionalCosts.push({key: '', value: 0});
                },

                // Remove additional cost by index
                removeAdditionalCost(index) {
                    this.additionalCosts.splice(index, 1);
                },

                // Calculate the total of additional costs
                calculateAdditionalCosts() {
                    return this.additionalCosts.reduce((total, cost) => total + parseFloat(cost.value || 0), 0);
                },

                calculateFinalCost() {
                    let subtotal = this.rows.reduce((total, row) => total + this.calculateLineTotal(row), 0);

                    // Apply purchase tax (either flat or percentage)
                    let purchaseTax = 0;

                    const selectedPurchaseTaxValue = this.taxes.find(tax => tax.name === this.purchaseTaxValue);

                    this.selectedPurchaseTaxObject = selectedPurchaseTaxValue;

                    if (selectedPurchaseTaxValue) {
                        if (selectedPurchaseTaxValue.type === 'percentage') {
                            purchaseTax = (subtotal * selectedPurchaseTaxValue.value) / 100;
                        } else if (selectedPurchaseTaxValue.type === 'flat') {
                            purchaseTax = selectedPurchaseTaxValue.value;
                        }
                    }

                    this.finalPurchaseTaxValue = purchaseTax;

                    // Calculate total with tax, shipping, and additional costs
                    let totalCost = subtotal + purchaseTax + parseFloat(this.shippingCost || 0) + this.calculateAdditionalCosts();

                    let globalDiscount = 0;
                    if (this.globalDiscountType === 'percentage') {
                        globalDiscount = (totalCost * this.globalDiscountValue) / 100;
                    } else if (this.globalDiscountType === 'flat') {
                        globalDiscount = parseFloat(this.globalDiscountValue || 0);
                    }
                    this.finalGlobalDiscount = globalDiscount;

                    // Subtract the global discount from the total cost
                    totalCost -= globalDiscount;

                    this.saveRowsToLocalStorage();  // Save current state to localStorage
                    return totalCost;
                }
            };
        }
    </script>
{% endblock %}
