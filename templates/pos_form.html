{% extends 'includes/main.html' %}
{% load static %}

{% block content %}

<div class=" container-fluid mb-4 mx-5 bg-white rounded pos-container" x-data="posApp()" x-init="focusSearchBar()">
    <div class="row">
        <!-- Customer Info -->
        <div class="col-md-12  my-4">
            <h4>Customer Information</h4>
            <form class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="customer-name" class="form-control" placeholder="Name"
                        x-model="customer.name">
                </div>
                <div class="col-md-3">
                    <input type="email" class="form-control" placeholder="Email" id="customer-email"
                        x-model="customer.email">
                </div>
                <div class="col-md-3">
                    <input type="tel" id="customer-phone" class="form-control" placeholder="Phone"
                        x-model="customer.phone">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Address" x-model="customer.address">
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- Product List -->
        <div class="col-md-8">
            <!-- Search Bar -->
            <div class="input-group mb-3 search-bar">
                <input type="text" id="search-bar" class="form-control" placeholder="Search products or scan barcode..."
                       x-model="searchQuery" @input="filterByBarcode">
                <button class="btn btn-outline-secondary" type="button" @click="searchQuery = ''">Clear</button>
            </div>
            
            <!-- Products Table -->
            <div class="row mx-2">
                <p class="text-danger" x-text="errors"></p>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="product in filteredProducts" :key="product.id">
                            <tr>
                                <td x-text="product.name"></td>
                                <td>৳<span x-text="product.price.toFixed(2)"></span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm" @click="addToCart(product)">Add to
                                        Cart</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cart -->
        <div class="col-md-4">
            <h4>Cart</h4>
            <ul class="list-group mb-3">
                <template x-for="(item, index) in cart" :key="index">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">

                            <div>
                                <h6 class="my-0" x-text="item.name"></h6>
                                <small class="text-muted">৳<span x-text="item.price.toFixed(2)"></span> x
                                    <input type="number" min="1" class="form-control d-inline-block w-50"
                                        x-model.number="item.quantity" @change="updateCart()">
                                </small>
                            </div>
                        </div>
                        <div>
                            <strong>৳<span x-text="(item.price * item.quantity).toFixed(2)"></span></strong>
                            <button class="btn btn-sm btn-danger ms-2" @click="removeFromCart(index)">&times;</button>
                        </div>
                    </li>
                </template>
            </ul>
            <div class="d-flex justify-content-between cart-total">
                <span>Total:</span>
                <span>৳<span x-text="cartTotal.toFixed(2)"></span></span>
            </div>
            <button class="btn btn-success btn-block mt-3 w-100" @click="checkout">Checkout</button>
        </div>
    </div>
</div>

<!-- Modal for Shortcut Details -->
<div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shortcutsModalLabel">Keyboard Shortcuts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul>
                    <li><strong>Alt + A</strong>: Add first product to cart</li>
                    <li><strong>Alt + S</strong>: Add second product to cart</li>
                    <li><strong>Alt + D</strong>: Add third product to cart</li>
                    <li><strong>Alt + F</strong>: Add fourth product to cart</li>
                    <li><strong>Alt + C</strong>: Checkout</li>
                    <li><strong>Alt + N</strong>: Focus on customer name input</li>
                    <li><strong>Alt + P</strong>: Focus on customer phone input</li>
                    <li><strong>Alt + E</strong>: Focus on customer email input</li>
                    <li><strong>Alt + Q</strong>: Focus on search bar</li>
                </ul>
            </div>
        </div>
    </div>
</div>


<!-- Button to trigger Modal -->
<button type="button" class="btn btn-info position-fixed" data-bs-toggle="modal"
        data-bs-target="#shortcutsModal" style="bottom: 20px; right: 20px; z-index: 1050;">
    Show Shortcuts
</button>


{% endblock %}
<!-- Scripts -->
{% block js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function posApp() {
        return {
            products: [],
            searchQuery: '',
            customer: {
                name: '',
                email: '',
                phone: '',
                address: '',
            },
            cart: [],
            errors: '',
            
            async fetchProducts() {
                try {
                    let response = await fetch(`/api/v1/variants/?search=${this.searchQuery}`);
                    if (response.ok) {
                        let data = await response.json();
                        this.products = data.results.map(item => ({
                            id: item.id,
                            name: item.product.name,
                            price: parseFloat(item.price),
                            image: item.image,
                            barcode: item.sku
                        }));
                    } else {
                        console.error("Failed to fetch products");
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            },

            get filteredProducts() {
                if (this.searchQuery === '') {
                    return this.products;
                }
                return this.products.filter(product => product.name.toLowerCase().includes(this.searchQuery.toLowerCase()));
            },

            get cartTotal() {
                return this.cart.reduce((total, item) => total + item.price * item.quantity, 0);
            },

            addToCart(product) {
                this.errors = "";
                let item = this.cart.find(i => i.id === product.id);
                if (item) {
                    item.quantity++;
                } else {
                    this.cart.push({ ...product, quantity: 1 });
                }
            },

            removeFromCart(index) {
                this.cart.splice(index, 1);
            },

            updateCart() {
                this.cart = this.cart.filter(item => item.quantity > 0);
            },

            checkout() {
                if (this.cart.length === 0) {
                    alert('Cart is empty!');
                    return;
                }
                if (!this.customer.name || !this.customer.phone) {
                    alert('Please provide customer name and phone.');
                    return;
                }
                alert('Checkout successful!\nTotal: ৳' + this.cartTotal.toFixed(2));
                this.cart = [];
                this.customer = {
                    name: '',
                    email: '',
                    phone: '',
                    address: '',
                };
            },

            focusSearchBar() {
                document.getElementById('search-bar').focus();
            },

            async filterByBarcode() {
                await this.fetchProducts();  // Fetch filtered products
                
            },

            init() {
                this.fetchProducts();  // Initial fetch of all products

                document.addEventListener('keydown', (e) => {
                    if (e.altKey) {
                        switch (e.key.toLowerCase()) {
                            case 'a':
                                this.addToCart(this.products[0]);
                                break;
                            case 's':
                                this.addToCart(this.products[1]);
                                break;
                            case 'd':
                                this.addToCart(this.products[2]);
                                break;
                            case 'f':
                                this.addToCart(this.products[3]);
                                break;
                            case 'c':
                                this.checkout();
                                break;
                            case 'n':
                                document.getElementById('customer-name').focus();
                                break;
                            case 'p':
                                document.getElementById('customer-phone').focus();
                                break;
                            case 'q':
                                this.focusSearchBar();
                                break;
                            case 'e':
                                document.getElementById('customer-email').focus();
                                break;
                        }
                    }
                });
            }
        }
    }
</script>


<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}