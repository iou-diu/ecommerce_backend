{% extends 'includes/main.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center p-3 rounded-top">
                    <h4 class="card-title fw-bold m-0 px-4">
                        Add/Update Images of the Product: <b>{{ product.name }}</b>
                    </h4>
                    <div class="card-toolbar">
                        {% if list_link %}
                            <a href="{{ list_link }}" class="btn btn-light btn-sm d-flex align-items-center">
                                <i class="fas fa-list me-1"></i> {{ page_title }} Products List
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- New Image Upload Form -->
                    <h5 class="mb-4">Upload New Image</h5>
                    {% include 'includes/form.html' %}
                    <hr>

                    <!-- Image Gallery -->
                    <h5 class="mt-5 mb-3">Existing Images</h5>
                    <div class="row row-cols-1 row-cols-md-3 g-4">
                        {% for image in product_images %}
                            <div class="col mt-5">
                                <div class="card h-auto shadow-sm">
                                    <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.alt_text }}">
                                    <div class="card-body d-flex align-items-center justify-content-between">
                                        <p class="card-text mb-0" style="flex: 1; margin-right: 10px;">{{ image.alt_text }}</p>
                                        {% if image.is_featured %}
                                            <span class="badge bg-success mb-2">Featured</span>
                                        {% endif %}
                                        <!-- Delete icon -->
                                        <div class="delete-icon" data-id="{{ image.id }}" style="cursor: pointer; flex: 0 0 auto;">
                                            <i class="fas fa-trash text-danger" aria-hidden="true" title="Delete Image"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted text-center">No images for this product yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    $(document).ready(function() {
        $('.delete-icon').on('click', function() {
            const imageId = $(this).data('id'); // Assuming you store the ID in a data attribute
    
            if (confirm("Are you sure you want to delete this image?")) {
                $.ajax({
                    url: "{% url 'delete_product_image' 0 %}".replace('0', imageId), // Update the URL based on your URL config
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({}),
                    success: function(response) {
                        if (response.success) {
                            alert(response.message); // Show success message
                            location.reload(); // Refresh the page
                        } else {
                            alert(response.message); // Show error message
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        alert("An error occurred: " + textStatus);
                    }
                });
            }
        });
    });
</script>
{% endblock %}
